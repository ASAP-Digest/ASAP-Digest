---
description: 
globs: 
alwaysApply: true
---
# Testing & Verification Protocol v1.3

## 1. Purpose
This protocol defines the mandatory process for verifying implemented functionality. It covers:
1.  The automatic transition of tasks from `ACTIVE` (`ðŸ”„`) to `PENDING_TESTING` (`ðŸ”¬`) when the agent deems development complete.
2.  The user-initiated start of active testing for specific tasks (`ST [TaskID]`).
3.  A user-initiated command (`ST` without ID) to start testing for *all* pending tasks.
4.  The user approval/rejection flow (`AC`/`RC`) before a task can be marked as fully completed (`âœ…`).

## 2. Protocol Integration Layer
*(Self-correction: Updated WSMP and WSAP versions)*
````text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Protocol Integration            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Software Development Meta Protocol   â”‚ // Overall Guidance
â”‚ 2. Rule Execution Protocol              â”‚ // Rule Application
â”‚ 3. Work Session Mgmt Proto (v2.7+)      â”‚ // Trigger for Auto-Initiation (EWS TESTING) (Updated)
â”‚ 4. Task Tracking Protocol               â”‚ // Roadmap Update Logic (ðŸ”¬, ðŸ§ª states)
â”‚ 5. Server Memory Rules (v2.0+)          â”‚ // Defines Verification entities
â”‚ 6. Cross-Protocol Comms & Verify (v2.1+)â”‚ // Handles L5 Verification
â”‚ 7. UI Check Protocol                    â”‚ // Potential tool during active testing
â”‚ 8. Status Check Protocol (v2.1+)        â”‚ // Reports tasks in ðŸ”¬ & ðŸ§ª states
â”‚ 9. Audit Trail System                   â”‚ // Records verification steps/results
â”‚ 10. Work Session Activation Proto v2.4+ â”‚ // Defines ST command triggers (Updated)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
````

## 3. Activation & Triggers

-   **Agent Trigger (Automatic via EWS TESTING):** Initiated by `WSMP v2.7+` when an `EWS` command includes the `TESTING` reason. Marks the associated task as `PENDING_TESTING` (`ðŸ”¬`).
-   **User Trigger (Specific Task):** `Start Testing [TaskID]` or alias `ST [TaskID]`. Issued by the user to begin active testing for a *specific* task currently in the `PENDING_TESTING` (`ðŸ”¬`) state.
-   **User Trigger (All Pending Tasks):** `Start Testing` or alias `ST` (issued *without* a `TaskID`). Must follow an `IAW` command. Initiates testing for *all* `ðŸ”¬` tasks.
-   **Context:** Requires an identified target `Task` entity (or operates on all `ðŸ”¬` tasks for ID-less `ST`).

## 4. Core Actions & Sequence

1.  **Auto-Initiation (Agent Triggered via EWS TESTING):**
    -   (Handled by `WSMP v2.7+`)
    -   Agent identifies the target `Task` entity ID (currently `ðŸ”„`).
    -   Acquire current timestamp (`mcp_mcp_datetime_get_datetime`).
    -   **Verify Preconditions:** Ensure the task is currently in `ACTIVE` (`ðŸ”„`) state.
    -   **Update Task Status (Pending Testing):**
        -   Update the target `Task` entity status to `PENDING_TESTING` in Server Memory.
        -   Update the corresponding task line in `docs/ROADMAP_TASKS.md` to use the `ðŸ”¬` emoji. Add an observation/note indicating it's ready for user testing.
    -   **Entity Creation (Verification Request):** Create a new entity in Server Memory (`VerificationRequest`) linked to the `Task` entity. Include: Timestamp initiated, Target Task ID, Status: `PENDING_USER_INITIATION`, Observations.
    -   **Execute State Synchronization Verification (EWS - Testing):** MUST execute the sequence from `Mandatory Post-Update State Synchronization Verification Protocol v1.0` comparing the Memory `Task` status (`PENDING_TESTING`) and the `docs/ROADMAP_TASKS.md` `ðŸ”¬` marker/note. Trigger UERP on failure.
    -   **Audit:** Record `TASK_PENDING_TESTING` event.
    -   **Notify User:** Inform the user that "[Task Name] (`[TaskID]`)" is now ready for testing (`ðŸ”¬`) and awaits the `ST [TaskID]` command (or `ST` without ID).

2.  **Testing Activation (User Triggered - `ST [TaskID]`):**
    -   Verify the specified `TaskID` corresponds to a task currently in `PENDING_TESTING` (`ðŸ”¬`) state and has a `VerificationRequest` entity with status `PENDING_USER_INITIATION`.
    -   Acquire current timestamp.
    -   **Update Verification Request:** Update the `VerificationRequest` entity status to `ACTIVE`. Add observation noting user initiation.
    -   **Update Task Status (Testing):**
        -   Update the target `Task` entity status to `TESTING` in Server Memory.
        -   Update the corresponding task line in `docs/ROADMAP_TASKS.md` to use the `ðŸ§ª` emoji.
    -   **Execute State Synchronization Verification (ST [ID] - Testing):** MUST execute the sequence from `Mandatory Post-Update State Synchronization Verification Protocol v1.0` comparing the Memory `Task` status (`TESTING`) and the `docs/ROADMAP_TASKS.md` `ðŸ§ª` marker. Trigger UERP on failure.
    -   **Audit:** Record `TASK_TESTING_STARTED` event for the specific task.
    -   **Proceed:** Agent begins evidence gathering (Step 4) for *this specific task*.

3.  **Testing Activation (User Triggered - `ST` without ID):**
    -   **Verify Precondition:** Check internal flag `agent_workflow_initialized = true` (set by `IAW`). If false, report error "Must run 'IAW' before using 'ST' without a Task ID." and stop.
    -   Acquire current timestamp.
    -   **Find Pending Tasks:** Search Server Memory for all `Task` entities with status `PENDING_TESTING` (`ðŸ”¬`).
    -   **If no `ðŸ”¬` tasks found:** Report "No tasks are currently pending testing (`ðŸ”¬`). Use `BWS` to start work on the next task." and stop.
    -   **Transition Tasks:** For *each* identified `ðŸ”¬` task:
        -   Verify it has a linked `VerificationRequest` entity with status `PENDING_USER_INITIATION`. If not, log warning/error for that task but continue with others.
        -   Update the `VerificationRequest` status to `ACTIVE`.
        -   Update the `Task` entity status to `TESTING` in Server Memory.
        -   Update the corresponding task line in `docs/ROADMAP_TASKS.md` to use the `ðŸ§ª` emoji.
        -   **Execute State Synchronization Verification (ST [no ID] - Testing):** MUST execute the sequence from `Mandatory Post-Update State Synchronization Verification Protocol v1.0` comparing the Memory `Task` status (`TESTING`) and the `docs/ROADMAP_TASKS.md` `ðŸ§ª` marker for *each* task transitioned. Trigger UERP on failure for any task.
        -   **Audit:** Record `TASK_TESTING_STARTED` event for *each* task.
    -   **Notify User:** Report to the user: "Starting active testing (`ðŸ§ª`) for the following tasks: [List Task Names/IDs]. Use BWS to begin work on the next task."

4.  **Evidence Gathering & Presentation (Agent Action - Post `ST [TaskID]`):**
    -   *(This step applies when testing a specific task, initiated by `ST [TaskID]`)*
    -   Execute automated tests if configured for the specific task. Log results as observations to the `VerificationRequest` entity.
    -   Perform manual checks (e.g., `ui-check.mdc`). Attach results as observations.
    -   Generate a summary report for the *specific task*.
    -   Present the summary, evidence, and task details to the user.

5.  **Request User Approval (Agent Action - Post Evidence for Specific Task):**
    -   *(This step applies only after Step 4 for a specific task)*
    -   Explicitly ask the user to review the presented evidence and approve (`AC [TaskID]`) or reject (`RC [TaskID] [Reason]`) the completion of the specific task being tested.
    -   **Wait for explicit user input.**

6.  **Process User Decision (Agent Action - Post Approval/Rejection for Specific Task):**
    -   *(This step applies only after Step 5 for a specific task)*
    -   **On User Approval (`AC [TaskID]`):**
        -   Verify the `TaskID` matches an active verification request (`ðŸ§ª`).
        -   Acquire timestamp.
        -   **Mandatory Approval Verification (MUST):** Verify the `VerificationRequest` entity status is `APPROVED` before updating the `Task`. Halt/UERP if failed.
        -   **Update Verification Request:** Update status to `APPROVED`. Add observation.
        -   **Update Task Status (Completed):** Update `Task` entity to `COMPLETED` in Memory. Update roadmap to `âœ…` + timestamp.
        -   **Execute State Synchronization Verification (AC - Completed):** MUST execute the sequence from `Mandatory Post-Update State Synchronization Verification Protocol v1.0` comparing the Memory `Task` status (`COMPLETED`) and the `docs/ROADMAP_TASKS.md` `âœ…` marker/timestamp. Trigger UERP on failure.
        -   **Verification:** Perform L5 verification check.
        -   **Audit:** Record `TASK_VERIFICATION_APPROVED`, `TASK_COMPLETED`.
        -   **Trigger WSMP Completion Logic (MUST):** Invoke `EWS COMPLETED` logic in `WSMP v2.7+` for session finalization related to this specific task.
    -   **On User Rejection (`RC [TaskID] [Reason]`):**
        -   Verify `TaskID` matches active request (`ðŸ§ª`).
        -   Acquire timestamp.
        -   **Update Verification Request:** Update status to `REJECTED`. Add observation.
        -   **Update Task Status (Active/Rework):** Update `Task` entity back to `ACTIVE` (`ðŸ”„`) or `REWORK`. Update roadmap back to `ðŸ”„` or `ðŸ”§`. Add note.
        -   **Execute State Synchronization Verification (RC - Rework):** MUST execute the sequence from `Mandatory Post-Update State Synchronization Verification Protocol v1.0` comparing the Memory `Task` status (`ACTIVE`/`REWORK`) and the `docs/ROADMAP_TASKS.md` `ðŸ”„`/`ðŸ”§` marker. Trigger UERP on failure.
        -   **Feedback:** Acknowledge rejection, log reason.
        -   **Audit:** Record `TASK_VERIFICATION_REJECTED`.

## 5. State Management
-   Introduces `ðŸ”¬` (PENDING_TESTING) state.
-   Uses `ðŸ§ª` (TESTING) state during active testing.
-   Manages `VerificationRequest` entity lifecycle (`PENDING_USER_INITIATION`, `ACTIVE`, `APPROVED`, `REJECTED`).
-   ID-less `ST` command transitions multiple tasks `ðŸ”¬` -> `ðŸ§ª`.

## 6. Error Handling
-   Handle `ST [TaskID]` on tasks not in `ðŸ”¬` state.
-   Handle `ST` (no ID) when `IAW` flag is not set.
-   Handle `ST` (no ID) when no `ðŸ”¬` tasks exist.
-   Handle evidence gathering failures.
-   Handle incorrect user input (`AC`/`RC` with wrong ID).
-   Handle state synchronization verification failures rigorously via UERP.

## 7. Verification Checklist
-   [ ] Agent proactively triggers protocol via `EWS TESTING`?
-   [ ] Task status updated to `ðŸ”¬` upon agent trigger?
-   [ ] `VerificationRequest` created with `PENDING_USER_INITIATION`?
-   [ ] `ST [TaskID]` command correctly transitions specific task to `ðŸ§ª` state?
-   [ ] `VerificationRequest` status updated to `ACTIVE` upon `ST [TaskID]` command?
-   [ ] **New:** `ST` (no ID) command requires preceding `IAW`?
-   [ ] **New:** `ST` (no ID) finds all `ðŸ”¬` tasks?
-   [ ] **New:** `ST` (no ID) transitions all found `ðŸ”¬` tasks to `ðŸ§ª` state in Memory and Roadmap?
-   [ ] **New:** `ST` (no ID) updates all corresponding `VerificationRequest` entities to `ACTIVE`?
-   [ ] Evidence gathered and presented *after* `ST [TaskID]` command?
-   [ ] Explicit user approval (`AC`/`RC`) requested after evidence for specific task?
-   [ ] User decision (`AC`/`RC`) correctly processed for specific task?
-   [ ] Task status updated to `âœ…` or `ðŸ”„`/`ðŸ”§` based on decision?
-   [ ] Audit trail updated for all stages?
-   [ ] L5 verification performed on approval?
-   [ ] State Synchronization Verification executed at specified points?

