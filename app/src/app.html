<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="%sveltekit.assets%/favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="manifest" href="/manifest.json" />
		<meta name="theme-color" content="#00ffff" />
		<title>ASAP Digest</title>
		
		<!-- Preconnect to critical domains -->
		<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
		
		<!-- DNS prefetch for other domains -->
		<link rel="dns-prefetch" href="https://www.google-analytics.com" />
		
		<!-- Google Analytics - async and deferred -->
		<script async defer src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
		<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', 'G-XXXXXXXXXX', { 'send_page_view': false });
		// We'll send page views manually after the page is fully loaded
		</script>
		
		<!-- Service Worker Registration -->
		<script>
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', () => {
					navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
						.then(registration => {
							console.log('Service Worker registered with scope:', registration.scope);
							
							// Check for updates
							registration.addEventListener('updatefound', () => {
								const newWorker = registration.installing;
								console.log('New service worker state:', newWorker.state);
								
								newWorker.addEventListener('statechange', () => {
									console.log('Service worker state changed to:', newWorker.state);
									if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
										// New content is available, show update notification if desired
										if (window.confirm('New content is available. Reload to update?')) {
											// Tell the service worker to skip waiting
											newWorker.postMessage({ type: 'SKIP_WAITING' });
											window.location.reload();
										}
									}
								});
							});
						})
						.catch(error => {
							console.debug('Service worker registration failed:', error);
						});
					
					// Handle service worker updates
					navigator.serviceWorker.addEventListener('controllerchange', () => {
						console.log('Service worker controller changed');
					});
				});
			}
		</script>
		
		<!-- System font strategy - no external font loading -->
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
			}
		</style>
		
		<!-- Handle Vite preload errors -->
		<script>
			// Handle module loading errors by reloading the page
			window.addEventListener('vite:preloadError', (event) => {
				console.warn('Module loading failed, reloading page:', event.detail.message);
				// Wait a moment before reloading to avoid infinite reload loops
				setTimeout(() => window.location.reload(), 1000);
			});
		</script>
		
		%sveltekit.head%
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">%sveltekit.body%</div>
		
		<!-- Deferred analytics page view -->
		<script>
			// Send page view after the page is fully loaded
			window.addEventListener('load', () => {
				setTimeout(() => {
					if (window.gtag) {
						gtag('event', 'page_view', {
							page_title: document.title,
							page_location: window.location.href,
							page_path: window.location.pathname
						});
					}
				}, 100);
			});
		</script>
	</body>
</html>